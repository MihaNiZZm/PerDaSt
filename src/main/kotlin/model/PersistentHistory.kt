package com.github.mihanizzm.model

/**
 * Менеджер версий для персистентных структур данных.
 *
 * Позволяет:
 * - получать текущую версию [cur],
 * - применять новую версию [update] (с отсечением «будущих» версий),
 * - выполнять откат [undo] и возврат [redo],
 * - проверять доступность операций [canUndo]/[canRedo].
 *
 * Модель работы:
 * - История представлена списком версий и указателем на текущую.
 * - Вызов [update] после [undo] удаляет все версии «справа» от текущей,
 *   и добавляет новую вершину истории.
 *
 * Тип [T] обычно — конкретная персистентная структура (мапа/массив), однако
 * класс работает с любыми типами без ограничений.
 */
class PersistentHistory<T>(initial: T) {
    private val history = mutableListOf(initial)
    private var pointer = 0

    /**
     * Текущая версия.
     */
    fun cur(): T = history[pointer]

    /**
     * Добавляет новую версию [newVersion] и делает её текущей.
     *
     * Если до этого был выполнен [undo] (то есть указатель находился не на конце),
     * все «будущие» версии отбрасываются.
     *
     * Возвращает новую текущую версию.
     */
    fun update(newVersion: T): T {
        if (pointer < history.lastIndex) {
            history.subList(pointer + 1, history.size).clear()
        }
        history.add(newVersion)
        pointer++
        return cur()
    }

    /**
     * Перемещает указатель на предыдущую версию, если это возможно.
     *
     * Если откат невозможен (мы в начале истории), остаётся текущая версия.
     * Возвращает актуальную (после операции) версию.
     */
    fun undo(): T {
        if (pointer > 0) pointer--
        return cur()
    }

    /**
     * Перемещает указатель на следующую версию, если это возможно.
     *
     * Если переход невозможен (мы в конце истории), остаётся текущая версия.
     * Возвращает актуальную (после операции) версию.
     */
    fun redo(): T {
        if (pointer < history.lastIndex) pointer++
        return cur()
    }

    /**
     * Признак возможности выполнить [undo].
     */
    fun canUndo() = pointer > 0

    /**
     * Признак возможности выполнить [redo].
     */
    fun canRedo() = pointer < history.lastIndex
}

